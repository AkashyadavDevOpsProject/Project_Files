AWSTemplateFormatVersion: 2010-09-09
Description: This stack template creates DMS pipeline to migrate one DB to another.
Metadata:
  "AWS::CloudFormation::Interface":
    ParameterGroups:
      - Label:
          default: Tag Configuration
        Parameters:
          - pApplicationName
          - pApplicationNameLC
          - pProject
          - pPurpose
      - Label:
          default: DMS Configuration
        Parameters:
          - pReplicationInstanceAllocatedStorage
          - pReplicationInstanceClass
          - pSourceDatabaseName
          - pSourceDatabaseEngine
          - pSourceDatabaseServerName
          - pSourceDatabasePort
          - pDmsReplicationTaskMigrationType
          - pDbSchemaName
          - pTargetDatabaseName
          - pTargetDatabaseEngine
          - pTargetDatabaseServerName
          - pTargetDatabasePort
    ParameterLabels:
      pApplicationName:
        default: Application Name
      pApplicationNameLC:
        default: Application Name Lower Case
      pProject:
        default: Project Name
      pPurpose:
        default: specify the purpose of the resource.
      pReplicationInstanceAllocatedStorage:
        default: Initial storage
      pReplicationInstanceClass:
        default: specify instance class
      pSourceDatabaseName:
        default: specify name of source endpoint database name
      pSourceDatabaseEngine:
        default: specify name of source endpoint database enginer
      pSourceDatabaseServerName:
        default: specify name of source endpoint database server name
      pSourceDatabasePort:
        default: specify name of source endpoint database port
      pTargetDatabaseName:
        default: specify name of target endpoint database name
      pTargetDatabaseEngine:
        default: specify name of target endpoint database enginer
      pTargetDatabaseServerName:
        default: specify name of target endpoint database server name
      pTargetDatabasePort:
        default: specify name of target endpoint database port
      pDmsReplicationTaskMigrationType:
        default: specify the migration type
      pDbSchemaName:
         default: DB schema name, which will be migrated
      
Parameters:

  pReplicationInstanceAllocatedStorage:
    Description: The amount of storage (in gigabytes) to be initially allocated for the replication instance.            
    Type: Number
    Default: 100

  pReplicationInstanceClass:
    Description: The compute and memory capacity of the replication instance as specified by the replication instance class.
    Type: String
    Default: dms.t2.medium
    AllowedValues:
      - dms.t2.micro
      - dms.t2.small
      - dms.t2.medium
      - dms.t3.medium
      - dms.t2.large
      - dms.c4.large
      - dms.c4.xlarge
      - dms.c4.2xlarge
      - dms.c4.4xlarge
      - dms.r5.xlarge

  pSourceDatabaseName:
    Description: The name of the source endpoint database. For a MySQL source or target endpoint, don't specify DatabaseName. To migrate to a specific database, use this setting and targetDbType.
    Type: String
    Default: DEV

  pSourceDatabaseEngine:
    Description: The type of engine for the source endpoint, depending on the EndpointType value.            
    Type: String
    Default: oracle
    AllowedValues:
      - mysql
      - oracle
      - postgres
      - mariadb
      - aurora
      - aurora-postgresql
      - opensearch
      - redshift
      - s3
      - db2
      - azuredb
      - sybase
      - dynamodb
      - mongodb
      - kinesis
      - kafka
      - elasticsearch
      - docdb
      - sqlserver
      - neptune

  pSourceDatabaseServerName:
    Description: The name of the server where the source endpoint database resides.            
    Type: String
    Default: endpoint

  pSourceDatabasePort:
    Description: The port used by the source endpoint database           
    Type: Number
    Default: 1521

  pTargetDatabaseName:
    Description: The name of the target endpoint database. For a MySQL source or target endpoint, don't specify DatabaseName. To migrate to a specific database, use this setting and targetDbType.
    Type: String
    Default: dms-trial

  pTargetDatabaseEngine:
    Description: The type of engine for the target endpoint, depending on the EndpointType value.            
    Type: String
    Default: aurora-postgresql
    AllowedValues:
      - mysql
      - oracle
      - postgres
      - mariadb
      - aurora
      - aurora-postgresql
      - opensearch
      - redshift
      - s3
      - db2
      - azuredb
      - sybase
      - dynamodb
      - mongodb
      - kinesis
      - kafka
      - elasticsearch
      - docdb
      - sqlserver
      - neptune

  pTargetDatabaseServerName:
    Description: The name of the server where the target endpoint database resides.            
    Type: String
    Default: dms-inst1.us-east-1.rds.amazonaws.com

  pTargetDatabasePort:
    Description: The port used by the target endpoint database           
    Type: Number
    Default: 3306

  pDmsReplicationTaskMigrationType:
    Description: The migration type
    Type: String
    Default: full-load
    AllowedValues:
      - full-load
      - cdc
      - full-load-and-cdc

  pDbSchemaName:
    Description: DB Schema name that will be migrated
    Type: String
    Default: testdatabase

  # Tag
  pApplicationName:
    Type: String
    Description: Enter the application name. If you are not sure then use the value from the project name in GitLab.
    Default: 'DMSTRIAL'
    AllowedPattern: >-
      (^[a-zA-Z0-9]+$)

  pApplicationNameLC:
    Type: String
    Description: Enter the application name. If you are not sure then use the value from the project name in GitLab.
    ConstraintDescription: The application name must be lowercase
    Default: 'dmstrial'
    AllowedPattern: >-
      (^[a-z0-9]+$)

  pProject:
    Type: String
    Description: Enter the Project name
    ConstraintDescription: Must specify value
    Default: 'dms'
    AllowedPattern: >-
      (^[a-zA-Z0-9]+$)

  pPurpose:
    Type: String
    Description: Enter the general purpose of the resource
    ConstraintDescription: Must specify value
    Default: TestDMS
    AllowedPattern: >-
      (^[a-zA-Z0-9]+$)

  pSsmSupportGroup:
    Type: AWS::SSM::Parameter::Value<String>
    Description: Support Group conveys email distribution list of the group that is supporting the resource(DO NOT MODIFY)
    Default: /account/config/SupportGroup
    AllowedValues:
      - /account/config/SupportGroup

  pSsmAppGroup:
    Type: AWS::SSM::Parameter::Value<String>
    Description: App Group conveys the application group the resource belongs to(DO NOT MODIFY)
    Default: /account/config/AppGroup
    AllowedValues:
      - /account/config/AppGroup

  pSsmLifeCycle:
    Type: AWS::SSM::Parameter::Value<String>
    Description: LifeCycle conveys the lifecycle of the resource(DO NOT MODIFY)
    Default: /account/config/LifeCycle
    AllowedValues:
      - /account/config/LifeCycle

  pSsmBusiness:
    Type: AWS::SSM::Parameter::Value<String>
    Description: Business conveys the division or office associated with the resource(DO NOT MODIFY)
    Default: /account/config/Business
    AllowedValues:
      - /account/config/Business

  pSsmBusinessLC:
    Type: AWS::SSM::Parameter::Value<String>
    Description: Business with the restriction that is lower case,SSM Parameter value for Division Name(DO NOT MODIFY)
    Default: /account/config/BusinessLowercase
    AllowedValues:
      - /account/config/BusinessLowercase

Resources:
  rAWSDmsRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: "DMS-vpc-role"
      # Permission boundaries only needed in DEV outside of Service Catalog CI/CD
      # For permission boundaries explained see 
      # Replace below permission boundary according to account specific value
      PermissionsBoundary: !Sub "arn:aws:iam::${AWS::AccountId}:policy/ccoe-ScopePermissions-cf_drp-Dev-Developer-Policy"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: 
              Service: 
                - "dms.amazonaws.com"
            Action:
              - sts:AssumeRole
      Path: "/"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonDMSVPCManagementRole
      Tags:
        - Key: Name
          Value: !Sub
          - '${Project}-${ApplicationName}-${Purpose}'
          - Project: !Ref pProject
            ApplicationName: !Ref pApplicationName
            Purpose: !Ref pPurpose
        - Key: LifeCycle
          Value: !Ref pSsmLifeCycle
        - Key: ApplicationName
          Value: !Ref pApplicationName
        - Key: Business
          Value: !Ref pSsmBusiness
        - Key: SupportGroup
          Value: !Ref pSsmSupportGroup
        - Key: AppGroup
          Value: !Ref pSsmAppGroup

  rReplicationInstanceSubnetGroup:
    Type: AWS::DMS::ReplicationSubnetGroup
    DependsOn: rAWSDmsRole
    Properties:
      ReplicationSubnetGroupDescription: !Sub '${AWS::StackName} DMS Subnet Group'
      ReplicationSubnetGroupIdentifier: !Sub '${AWS::StackName}-dms-subnet-group'
      SubnetIds:
       - Fn::ImportValue: VpcSubnet1
       - Fn::ImportValue: VpcSubnet2
      Tags:
        - Key: Name
          Value: !Sub
          - '${Project}-${ApplicationName}-${Purpose}'
          - Project: !Ref pProject
            ApplicationName: !Ref pApplicationName
            Purpose: !Ref pPurpose
        - Key: LifeCycle
          Value: !Ref pSsmLifeCycle
        - Key: ApplicationName
          Value: !Ref pApplicationName
        - Key: Business
          Value: !Ref pSsmBusiness
        - Key: SupportGroup
          Value: !Ref pSsmSupportGroup
        - Key: AppGroup
          Value: !Ref pSsmAppGroup

  rDmsecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties: 
      GroupDescription: "Allow access to RDS from dms"
      GroupName: "dms-rds"
      SecurityGroupIngress:
        - CidrIp: "10.0.0.0/8"
          FromPort: 3306
          ToPort: 3306
          IpProtocol: "tcp"
      VpcId: 
        "Fn::ImportValue": VpcId
      Tags:
        - Key: Name
          Value: !Sub
          - '${Project}-${ApplicationName}-${Purpose}'
          - Project: !Ref pProject
            ApplicationName: !Ref pApplicationName
            Purpose: !Ref pPurpose
        - Key: LifeCycle
          Value: !Ref pSsmLifeCycle
        - Key: ApplicationName
          Value: !Ref pApplicationName
        - Key: Business
          Value: !Ref pSsmBusiness
        - Key: SupportGroup
          Value: !Ref pSsmSupportGroup
        - Key: AppGroup
          Value: !Ref pSsmAppGroup

  rReplicationInstance:
    Type: AWS::DMS::ReplicationInstance
    Properties:
      AllocatedStorage: !Ref pReplicationInstanceAllocatedStorage
      AllowMajorVersionUpgrade: false
      AutoMinorVersionUpgrade: false
      MultiAZ: false
      PubliclyAccessible: false
      KmsKeyId: !ImportValue DMSKeyArn
      ReplicationInstanceClass: !Ref pReplicationInstanceClass
      ReplicationInstanceIdentifier: !Sub '${AWS::StackName}-replication-instance'
      ReplicationSubnetGroupIdentifier: !Ref rReplicationInstanceSubnetGroup
      VpcSecurityGroupIds:
        - Fn::ImportValue: ccoe-general-sg
        - !GetAtt rDmsecurityGroup.GroupId
      Tags:
        - Key: Name
          Value: !Sub
          - '${Project}-${ApplicationName}-${Purpose}'
          - Project: !Ref pProject
            ApplicationName: !Ref pApplicationName
            Purpose: !Ref pPurpose
        - Key: LifeCycle
          Value: !Ref pSsmLifeCycle
        - Key: ApplicationName
          Value: !Ref pApplicationName
        - Key: Business
          Value: !Ref pSsmBusiness
        - Key: SupportGroup
          Value: !Ref pSsmSupportGroup
        - Key: AppGroup
          Value: !Ref pSsmAppGroup

  rDmsEndpointSource:
    Type: AWS::DMS::Endpoint
    Properties:
      DatabaseName: !Ref pSourceDatabaseName
      EndpointType: source
      EngineName: !Ref pSourceDatabaseEngine
      ServerName: !Ref pSourceDatabaseServerName
      Port: !Ref pSourceDatabasePort
      Username: '{{resolve:secretsmanager:test-oracle:SecretString:username}}'
      Password: '{{resolve:secretsmanager:test-oracle:SecretString:password}}'
      KmsKeyId: !ImportValue DMSKeyArn
      Tags:
        - Key: Name
          Value: !Sub
          - '${Project}-${ApplicationName}-${Purpose}'
          - Project: !Ref pProject
            ApplicationName: !Ref pApplicationName
            Purpose: !Ref pPurpose
        - Key: LifeCycle
          Value: !Ref pSsmLifeCycle
        - Key: ApplicationName
          Value: !Ref pApplicationName
        - Key: Business
          Value: !Ref pSsmBusiness
        - Key: SupportGroup
          Value: !Ref pSsmSupportGroup
        - Key: AppGroup
          Value: !Ref pSsmAppGroup

  rDmsEndpointTarget:
    Type: AWS::DMS::Endpoint
    Properties:
      DatabaseName: !Ref pTargetDatabaseName
      EndpointType: target
      EngineName: !Ref pTargetDatabaseEngine
      ServerName: !Ref pTargetDatabaseServerName
      Port: !Ref pTargetDatabasePort
      Username: '{{resolve:secretsmanager:dms-postgres:SecretString:username}}'
      Password: '{{resolve:secretsmanager:dms-postgres:SecretString:password}}'
      KmsKeyId: !ImportValue DMSKeyArn
      Tags:
        - Key: Name
          Value: !Sub
          - '${Project}-${ApplicationName}-${Purpose}'
          - Project: !Ref pProject
            ApplicationName: !Ref pApplicationName
            Purpose: !Ref pPurpose
        - Key: LifeCycle
          Value: !Ref pSsmLifeCycle
        - Key: ApplicationName
          Value: !Ref pApplicationName
        - Key: Business
          Value: !Ref pSsmBusiness
        - Key: SupportGroup
          Value: !Ref pSsmSupportGroup
        - Key: AppGroup
          Value: !Ref pSsmAppGroup

  rDmsReplicationTask:
    Type: AWS::DMS::ReplicationTask
    Properties:
      MigrationType: !Ref pDmsReplicationTaskMigrationType
      ReplicationInstanceArn: !Ref rReplicationInstance
      ReplicationTaskIdentifier: !Sub '${AWS::StackName}-dms-replication-task'
      SourceEndpointArn: !Ref rDmsEndpointSource
      TargetEndpointArn: !Ref rDmsEndpointTarget
      TableMappings:
                !Sub
                    - |-
                        {
                            "rules": [
                                {
                                    "rule-type": "selection",
                                    "rule-id": "1",
                                    "rule-action": "include",
                                    "object-locator": {
                                        "schema-name": "${db_schema_name}",
                                        "table-name": "%"
                                    },
                                    "rule-name": "1"
                                }
                            ]
                        }                        
                    -
                        db_schema_name: !Ref pDbSchemaName
      Tags:
        - Key: Name
          Value: !Sub
          - '${Project}-${ApplicationName}-${Purpose}'
          - Project: !Ref pProject
            ApplicationName: !Ref pApplicationName
            Purpose: !Ref pPurpose
        - Key: LifeCycle
          Value: !Ref pSsmLifeCycle
        - Key: ApplicationName
          Value: !Ref pApplicationName
        - Key: Business
          Value: !Ref pSsmBusiness
        - Key: SupportGroup
          Value: !Ref pSsmSupportGroup
        - Key: AppGroup
          Value: !Ref pSsmAppGroup

Outputs:
    DmsEndpointSource:
        Description: DMS source Endpoint
        Value: !Ref rDmsEndpointSource
        Export:
            Name: !Sub '${AWS::StackName}-dms-source-endpoint'
    DmsEndpointTarget:
        Description: DMS target Endpoint
        Value: !Ref rDmsEndpointTarget
        Export:
            Name: !Sub '${AWS::StackName}-dms-target-endpoint'
    ReplicationInstance:
        Description: DMS Replication Instance
        Value: !Ref rReplicationInstance
        Export:
            Name: !Sub '${AWS::StackName}-dms-replication-instance'
    DmsReplicationTask:
        Description: DMS Replication Task
        Value: !Ref rDmsReplicationTask
        Export:
            Name: !Sub '${AWS::StackName}-dms-replication-task'
